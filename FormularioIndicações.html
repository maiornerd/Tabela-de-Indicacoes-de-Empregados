<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabela de Indica√ß√µes para o Comit√™</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1e3a5f;
            --secondary-blue: #2c5f8d;
            --light-blue: #e8f1f8;
            --gray-dark: #4a4a4a;
            --gray-medium: #6b6b6b;
            --gray-light: #e0e0e0;
            --beige: #f5f3f0;
            --white: #ffffff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --purple: #6f42c1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--beige) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-dark);
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Cabe√ßalho */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Formul√°rio de informa√ß√µes */
        .info-form {
            padding: 25px 30px;
            background: var(--beige);
            border-bottom: 3px solid var(--gray-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--primary-blue);
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
        }

        .form-group input.error,
        .form-group select.error {
            border-color: var(--danger);
            background: #fff5f5;
        }

        /* Controles */
        .controls {
            padding: 20px 30px;
            background: var(--white);
            border-bottom: 2px solid var(--gray-light);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--secondary-blue);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--gray-dark);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }
        
        .btn-purple {
            background: var(--purple);
            color: var(--white);
        }
        
        .btn-purple:hover {
            background: #5a32a3;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Painel de Ordena√ß√£o */
        .sort-panel {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid var(--gray-light);
        }

        .sort-panel h3 {
            color: var(--primary-blue);
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-levels {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sort-level {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid var(--gray-light);
        }

        .sort-level label {
            font-weight: 600;
            min-width: 80px;
            color: var(--gray-dark);
        }

        .sort-level select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 14px;
        }

        /* Tabela */
        .table-container {
            padding: 30px;
            overflow-x: auto;
            max-height: 600px;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            font-size: 12px;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--primary-blue);
            color: var(--white);
        }

        thead th {
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            user-select: none;
            position: relative;
            font-size: 11px;
        }

        thead th:hover {
            background: var(--secondary-blue);
        }

        thead th:last-child {
            border-right: none;
        }

        thead th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 10px;
        }

        thead th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 10px;
        }

        thead th.th-center {
            text-align: center;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--gray-light);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--light-blue);
        }

        tbody tr.selected {
            background: #fff3cd;
        }

        tbody tr.row-error {
            background: #fff5f5;
        }

        tbody td {
            padding: 6px;
            border-right: 1px solid var(--gray-light);
        }

        tbody td:last-child {
            border-right: none;
        }

        .cell-input {
            width: 100%;
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 12px;
            background: transparent;
            transition: all 0.2s ease;
        }

        .cell-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(44, 95, 141, 0.1);
        }

        .cell-input.error {
            border-color: var(--danger);
            background: #fff5f5;
        }

        .cell-input:disabled,
        .cell-select:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
            color: #999;
        }

        .cell-select {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .cell-select.warning {
            border-color: var(--warning);
            background: #fffbf0;
        }

        .cell-select.error {
            border-color: var(--danger);
            background: #fff5f5;
        }

        /* Campo H√≠brido Data com N/A */
        .date-hybrid-wrapper {
            display: flex;
            gap: 3px;
            align-items: center;
            width: 100%;
        }

        .date-hybrid-select {
            flex: 0 0 55px;
            padding: 5px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            background-color: var(--white);
        }

        .date-hybrid-input {
            flex: 1;
            padding: 5px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .date-hybrid-input:disabled,
        .date-hybrid-select:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
            color: #999;
        }

        .checkbox-cell {
            text-align: center;
            width: 35px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 750px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            margin: auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .modal-header h2 {
            color: var(--primary-blue);
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-body {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-body p {
            margin-bottom: 10px;
        }

        .modal-body h3 {
            color: var(--secondary-blue);
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-body ul, .modal-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-body li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .modal-body .highlight {
            background: #fff3cd;
            padding: 12px;
            border-left: 4px solid var(--warning);
            border-radius: 4px;
            margin: 15px 0;
        }

        .modal-body .info-box {
            background: var(--light-blue);
            padding: 12px;
            border-left: 4px solid var(--info);
            border-radius: 4px;
            margin: 15px 0;
        }

        .modal-body .success-box {
            background: #d4edda;
            padding: 12px;
            border-left: 4px solid var(--success);
            border-radius: 4px;
            margin: 15px 0;
        }

        .modal-body .danger-box {
            background: #f8d7da;
            padding: 12px;
            border-left: 4px solid var(--danger);
            border-radius: 4px;
            margin: 15px 0;
        }

        .modal-body .warning-box {
            background: #fff3cd;
            padding: 12px;
            border-left: 4px solid var(--warning);
            border-radius: 4px;
            margin: 15px 0;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* RODAP√â */
        .footer {
            text-align: center;
            margin-top: 10px;
            padding: 15px;
            color: var(--gray-medium);
            font-size: 8px;
            border-top: 1px solid var(--gray-light);
            font-weight: 500;
        }
        
        /* Auto Save Indicator */
        #saveIndicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 1000;
        }

        /* Impress√£o */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .controls,
            .sort-panel,
            .btn,
            .checkbox-cell {
                display: none !important;
            }

            .table-container {
                max-height: none;
                overflow: visible;
            }

            thead {
                position: static;
            }

            .cell-input {
                border: none;
                padding: 4px;
            }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 10px;
            }

            .cell-input {
                font-size: 10px;
                padding: 4px;
            }

            .modal-content {
                padding: 20px;
                max-width: 100%;
            }

            .sort-level {
                flex-direction: column;
                align-items: stretch;
            }

            .date-hybrid-wrapper {
                flex-direction: column;
                gap: 2px;
            }

            .date-hybrid-select {
                width: 100%;
            }

            .date-hybrid-input {
                width: 100%;
            }
        }

        .keyboard-shortcut {
            display: inline-block;
            background: var(--gray-dark);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 0 4px;
        }

        .required-field::after {
            content: ' *';
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tabela de Indica√ß√µes para o Comit√™</h1>
        </div>

        <div class="info-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="responsavel" class="required-field">Nome do Respons√°vel</label>
                    <input type="text" id="responsavel" placeholder="Digite o nome do respons√°vel" oninput="saveData()" required>
                </div>
                <div class="form-group">
                    <label for="empresa" class="required-field">Selecione a Empresa</label>
                    <select id="empresa" onchange="saveData()" required>
                        <option value="">-- Selecione --</option>
                        <option value="1">1 - DeMillus SA</option>
                        <option value="2">2 - DM Lingerie Vendas de Confec√ß√µes Ltda</option>
                        <option value="3">3 - Texnor</option>
                        <option value="4">4 - Texpar</option>
                        <option value="8">8 - DM Lingerie S/A</option>
                        <option value="9">9 - BordTex</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-info" onclick="showInstructions()" title="Ver instru√ß√µes de uso (F1)">
                <span>‚ÑπÔ∏è</span> Instru√ß√µes de Uso
            </button>
            <button class="btn btn-danger" onclick="removeSelectedRows()" title="Remover linhas selecionadas">
                <span>üóëÔ∏è</span> Remover Selecionadas
            </button>
            <button class="btn btn-purple" onclick="clearAllData()" title="Apagar todos os dados e come√ßar do zero">
                <span>üßπ</span> Limpar Tabela
            </button>
            <button class="btn btn-success" onclick="showPDFModal()" title="Gerar PDF do documento (Ctrl+P)">
                <span>üìÑ</span> Gerar PDF
            </button>
            <button class="btn btn-warning" onclick="exportCSV()" title="Exportar dados para Excel/CSV (Ctrl+E)">
                <span>üìä</span> Exportar Arquivo
            </button>
            <button class="btn btn-primary" onclick="toggleSortPanel()" title="Mostrar/ocultar painel de ordena√ß√£o">
                <span>üîÄ</span> Ordena√ß√£o Avan√ßada
            </button>
            <button class="btn btn-primary" onclick="addRow()" title="Adicionar nova linha (Ctrl+N)">
                <span>‚ûï</span> Adicionar Linha
            </button>
        </div>

        <div class="sort-panel" id="sortPanel" style="display: none;">
            <h3>üîÄ Ordena√ß√£o Avan√ßada (Multi-n√≠vel)</h3>
            <div class="sort-levels">
                <div class="sort-level">
                    <label>1¬∫ N√≠vel:</label>
                    <select id="sort1Field">
                        <option value="">Selecione um campo</option>
                        <option value="matricula">Matr√≠cula</option>
                        <option value="nome">Nome</option>
                        <option value="setorOrigem">Setor Atual</option>
                        <option value="cargoAtual">Cargo Atual</option>
                        <option value="setorDestino">Setor de Destino</option>
                        <option value="cargoProposto">Cargo Proposto</option>
                        <option value="cargoLideranca">Cargo de Lideran√ßa?</option>
                        <option value="avaliacaoComportamental">R&S Avalia√ß√£o?</option>
                        <option value="emTreinamento">Em Treinamento?</option>
                        <option value="possuiCarta">Possui Carta?</option>
                        <option value="ehSubstituicao">√â Substitui√ß√£o?</option>
                    </select>
                    <select id="sort1Order">
                        <option value="asc">Crescente (A-Z / 0-9)</option>
                        <option value="desc">Decrescente (Z-A / 9-0)</option>
                    </select>
                </div>

                <div class="sort-level">
                    <label>2¬∫ N√≠vel:</label>
                    <select id="sort2Field">
                        <option value="">Nenhum</option>
                        <option value="matricula">Matr√≠cula</option>
                        <option value="nome">Nome</option>
                        <option value="setorOrigem">Setor Atual</option>
                        <option value="cargoAtual">Cargo Atual</option>
                        <option value="setorDestino">Setor de Destino</option>
                        <option value="cargoProposto">Cargo Proposto</option>
                        <option value="cargoLideranca">Cargo de Lideran√ßa?</option>
                        <option value="avaliacaoComportamental">R&S Avalia√ß√£o?</option>
                        <option value="emTreinamento">Em Treinamento?</option>
                        <option value="possuiCarta">Possui Carta?</option>
                        <option value="ehSubstituicao">√â Substitui√ß√£o?</option>
                    </select>
                    <select id="sort2Order">
                        <option value="asc">Crescente (A-Z / 0-9)</option>
                        <option value="desc">Decrescente (Z-A / 9-0)</option>
                    </select>
                </div>

                <div class="sort-level">
                    <label>3¬∫ N√≠vel:</label>
                    <select id="sort3Field">
                        <option value="">Nenhum</option>
                        <option value="matricula">Matr√≠cula</option>
                        <option value="nome">Nome</option>
                        <option value="setorOrigem">Setor Atual</option>
                        <option value="cargoAtual">Cargo Atual</option>
                        <option value="setorDestino">Setor de Destino</option>
                        <option value="cargoProposto">Cargo Proposto</option>
                        <option value="cargoLideranca">Cargo de Lideran√ßa?</option>
                        <option value="avaliacaoComportamental">R&S Avalia√ß√£o?</option>
                        <option value="emTreinamento">Em Treinamento?</option>
                        <option value="possuiCarta">Possui Carta?</option>
                        <option value="ehSubstituicao">√â Substitui√ß√£o?</option>
                    </select>
                    <select id="sort3Order">
                        <option value="asc">Crescente (A-Z / 0-9)</option>
                        <option value="desc">Decrescente (Z-A / 9-0)</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 12px;">
                <button class="btn btn-success" onclick="applyAdvancedSort()">
                    <span>‚úì</span> Aplicar Ordena√ß√£o
                </button>
                <button class="btn btn-danger" onclick="clearSort()">
                    <span>‚úó</span> Limpar Ordena√ß√£o
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="selectAllRows(this)"></th>
                        <th onclick="quickSort('matricula')" title="Clique para ordenar">Matr√≠cula *</th>
                        <th onclick="quickSort('nome')" title="Clique para ordenar">Nome Completo *</th>
                        <th onclick="quickSort('setorOrigem')" title="Clique para ordenar">Setor Atual *</th>
                        <th onclick="quickSort('cargoAtual')" title="Clique para ordenar">Cargo Atual *</th>
                        <th onclick="quickSort('codSetorDestino')" title="Clique para ordenar">C√≥d. Setor Destino *</th>
                        <th onclick="quickSort('setorDestino')" title="Clique para ordenar">Setor de Destino *</th>
                        <th onclick="quickSort('cargoProposto')" title="Clique para ordenar">Cargo Proposto *</th>
                        <th onclick="quickSort('cargoLideranca')" title="Clique para ordenar">Cargo Proposto √©<br>de Lideran√ßa? *</th>
                        <th onclick="quickSort('avaliacaoComportamental')" title="Clique para ordenar">R&S fez<br>Avalia√ß√£o?</th>
                        <th onclick="quickSort('dataAvaliacaoComp')" title="Clique para ordenar" class="th-center">Data da Avalia√ß√£o<br>Comportamental</th>
                        <th onclick="quickSort('emTreinamento')" title="Clique para ordenar">Em Treinamento? *</th>
                        <th onclick="quickSort('possuiCarta')" title="Clique para ordenar">Possui Carta? *</th>
                        <th onclick="quickSort('dataInicio')" title="Clique para ordenar" class="th-center">Data do In√≠cio<br>do Treinamento</th>
                        <th onclick="quickSort('ehSubstituicao')" title="Clique para ordenar">√â Substitui√ß√£o?</th>
                        <th onclick="quickSort('matriculaSubstituto')" title="Clique para ordenar">Matr√≠cula do<br>Substitu√≠do *</th>
                        <th onclick="quickSort('nomeSubstituto')" title="Clique para ordenar">Nome Completo<br>do Substitu√≠do *</th>
                        <th onclick="quickSort('motivoSubstituicao')" title="Clique para ordenar">Motivo da<br>Substitui√ß√£o *</th>
                        <th onclick="quickSort('dataDesligamento')" title="Clique para ordenar" class="th-center">Data do Motivo<br>da Substitui√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>

        <div class="footer">
            Tabela criada e desenvolvida por Alan Silva. <br>
            ¬© 2026 Todos os direitos reservados.
        </div>
        
    </div>

    <div id="customAlertModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="customAlertTitle">‚ö†Ô∏è Aten√ß√£o</h2>
            </div>
            <div class="modal-body">
                <p id="customAlertMessage" style="white-space: pre-line; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeCustomAlert()">Entendi</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="customConfirmTitle">‚ö†Ô∏è Aten√ß√£o</h2>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage" style="white-space: pre-line; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeCustomConfirm()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÑ Confirmar Gera√ß√£o de PDF</h2>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closePDFModal()">Cancelar</button>
                <button class="btn btn-success" onclick="generatePDF()">Confirmar e Gerar PDF</button>
            </div>
        </div>
    </div>

    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è Instru√ß√µes de Uso da Tabela de Indica√ß√µes para o Comit√™</h2>
            </div>
            <div class="modal-body">
                <p style="font-size: 14px; color: var(--gray-medium); margin-bottom: 20px;">
                    Siga estas orienta√ß√µes para preencher corretamente a tabela de indica√ß√µes e gerar os documentos para envio.
                </p>
                <div class="highlight">
                    <strong>‚ùóAten√ß√£o e Recursos Autom√°ticos:</strong>
                    <ul style="margin-top: 8px; margin-bottom: 0;">
                        <li>Campos marcados com asterisco <strong>(*)</strong> s√£o obrigat√≥rios.</li>
                        <li>üíæ <strong>Salvamento Autom√°tico:</strong> Seus dados s√£o salvos localmente enquanto voc√™ digita.</li>
                        <li>üî¢ <strong>Matr√≠cula:</strong> O campo aceita apenas n√∫meros e bloqueia duplicidades em tempo real.</li>
                    </ul>
                </div>

                <h3>üîÑ Recupera√ß√£o de Preenchimento (Pop-up Inicial)</h3>
                <div class="info-box">
                    <p>Ao abrir o sistema, se houver dados de um preenchimento anterior, uma janela aparecer√° com duas op√ß√µes:</p>
                    <ul style="margin-top: 8px;">
                        <li><strong>SIM, CONTINUAR:</strong> Restaura a tabela exatamente como voc√™ a deixou (mesmo se o computador foi desligado).</li>
                        <li><strong>LIMPAR TABELA:</strong> Inicia um processo para apagar todos os dados salvos e come√ßar uma lista do zero (ser√° pedida uma confirma√ß√£o extra por seguran√ßa).</li>
                    </ul>
                </div>

                <h3>üìã 1. Informa√ß√µes do Cabe√ßalho (Obrigat√≥rias)</h3>
                <div class="info-box">
                    <ul style="margin-top: 8px;">
                        <li><strong>Nome do Respons√°vel:</strong> Informe o nome completo do Gestor demandante</li>
                        <li><strong>Selecione a Empresa:</strong> Escolha a empresa correspondente</li><br>
                        <strong>‚ÄºÔ∏èObs.:</strong> Dever√° ser feita uma lista de empregado para cada empresa.
                    </ul>
                </div>

                <h3>‚å®Ô∏è 2. Navega√ß√£o com Teclado</h3>
                <div class="info-box">
                    <ul style="margin-top: 8px;">
                        <li><strong>TAB:</strong> Navegar para o pr√≥ximo campo</li>
                        <li><strong>Shift + TAB:</strong> Navegar para o campo anterior</li>
                        <li><strong>SETAS (‚Üí ‚Üê ‚Üë ‚Üì):</strong> Mover entre c√©lulas da tabela</li>
                        <li><strong>ENTER:</strong> Confirmar entrada e mover para o pr√≥ximo campo</li>
                    </ul>
                </div>

                <h3>‚úèÔ∏è 3. Preenchimento da Tabela</h3>
                <ol>
                    <li><strong>Matr√≠cula:</strong> Este campo √© obrigat√≥rio. Preencher apenas com n√∫meros. <br> N√£o repita a matr√≠cula!</br></li>
                    <li><strong>Nome Completo:</strong> Este campo √© obrigat√≥rio. Digite o nome completo do empregado</li>
                    <li><strong>Setor Atual:</strong> Este campo √© obrigat√≥rio. Informe o nome do setor atual</li>
                    <li><strong>Cargo Atual:</strong> Este campo √© obrigat√≥rio. Informe o nome do cargo que o empregado ocupa atualmente</li>
                    <li><strong>C√≥d. Setor Destino:</strong> Campo obrigat√≥rio. Digite exatamente 10 n√∫meros e ser√° formatado automaticamente (ex: 0102345600 ‚Üí 0102.3.4.5.6.00)</li>
                    <li><strong>Setor de Destino:</strong> Este campo √© obrigat√≥rio. Informe o nome do setor para onde o(s) empregado(s) ser√°(√£o) promovido(s)/transferido(s).</li>
                    <li><strong>Cargo Proposto:</strong> Este campo √© obrigat√≥rio. Informe o nome do novo cargo ap√≥s a promo√ß√£o, ou repita o nome do cargo atual caso n√£o haja mudan√ßa.</li>
                </ol>

                <h3>üîí 4. Campos com Condi√ß√µes Especiais</h3>
                <div class="highlight">
                    <strong>‚ö†Ô∏è REGRA CR√çTICA - Cargo Proposto √© de Lideran√ßa? = SIM</strong>
                    <p style="margin-top: 8px;">Se selecionado <strong>"SIM"</strong> e o campo "R&S fez Avalia√ß√£o?" estiver com <strong>"N√ÉO"</strong>:</p>
                    <ul style="margin-top: 8px;">
                        <li>‚ùå Ser√° exibido um alerta indicando que esse candidato n√£o pode ser movimentado</li>
                        <li>‚ùå Os arquivos PDF e CSV/Excel/Libre Office Calc <U>N√ÉO</U> poder√£o ser gerados</li>
                        <li>‚úÖ Retire o candidato da lista e solicite a Avalia√ß√£o Comportamental √† √°rea de Recrutamento e Sele√ß√£o (R&S)</li>
                        <li>‚ö†Ô∏è Se estiver selecionado "N/A" os outros campos estar√£o livres para preenchimento</li>
                    </ul>
                    <p style="margin-top: 10px; border-top: 1px dashed #c0a16b; padding-top: 8px;"><strong>üìÖ Nova Regra: Data Obrigat√≥ria</strong></p>
                    <ul style="margin-top: 5px;">
                        <li>Se "R&S fez Avalia√ß√£o?" for <strong>"SIM"</strong>, o preenchimento da <strong>Data da Avalia√ß√£o Comportamental</strong> √© <strong>OBRIGAT√ìRIO</strong>.</li>
                        <li>‚ùå Caso falte a data, a linha ficar√° destacada em vermelho e os arquivos n√£o ser√£o gerados.</li>
                    </ul>
                </div>
                
                 <div class="highlight">
                    <strong>‚ö†Ô∏è REGRA CR√çTICA - Em Treinamento? = SIM</strong>
                    <p style="margin-top: 8px;">Se selecionado <strong>"SIM"</strong> e o campo "Possui Carta?" estiver com <strong>"N√ÉO"</strong>:</p>
                    <ul style="margin-top: 8px;">
                        <li>‚ùå Ser√° exibido um alerta indicando que esse candidato n√£o pode ser movimentado sem carta</li>
                        <li>‚ùå Os arquivos PDF e CSV/Excel/Libre Office Calc <U>N√ÉO</U> poder√£o ser gerados</li>
                         <li>‚úÖ Contacte a Ger√™ncia do Departamento Pessoal para elaborar a carta de treinamento e coletar as assinaturas</li>
                    </ul>
                    <p style="margin-top: 10px; border-top: 1px dashed #c0a16b; padding-top: 8px;"><strong>üìÖ Nova Regra: Data Obrigat√≥ria</strong></p>
                    <ul style="margin-top: 5px;">
                        <li>Se "Possui Carta?" for <strong>"SIM"</strong>, o preenchimento da <strong>Data do In√≠cio do Treinamento</strong> √© <strong>OBRIGAT√ìRIO</strong>.</li>
                        <li>‚ùå Caso falte a data, a linha ficar√° destacada em vermelho e os arquivos n√£o ser√£o gerados.</li>
                    </ul>
                </div>

                <div class="highlight">
                    <strong>‚ö†Ô∏è REGRA CR√çTICA - Matr√≠culas Repetidas</strong>
                    <p style="margin-top: 8px;">Se houver <strong>"matr√≠cula"</strong> repetida na tabela:</p>
                    <ul style="margin-top: 8px;">
                        <li>‚ùå Ser√° exibido um alerta indicando quais matr√≠culas aparecem repetidas</li>
                        <li>‚ùå Os arquivos PDF e CSV/Excel/Libre Office Calc <U>N√ÉO</U> poder√£o ser gerados</li>
                        <li>‚úÖ Retire e/ou altere a matr√≠cula informada</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è √â Substitui√ß√£o? = SIM ou N√ÉO</strong>
                    <p style="margin-top: 8px;">Se estiver selecionado <strong>"SIM"</strong></p>
                    <ul style="margin-top: 8px;">
                        <li>‚ö†Ô∏è Os campos de Substitui√ß√£o (Matr√≠cula, Nome, Motivo) estar√£o habilitados e s√£o obrigat√≥rios.</li>
                        <li>‚ö†Ô∏è A <strong>Data do Motivo da Substitui√ß√£o</strong> √© de preenchimento <strong>OBRIGAT√ìRIO</strong>. A falta desta data bloquear√° a gera√ß√£o dos arquivos e destacar√° a linha em vermelho.</li>
                        <li>‚ö†Ô∏è Se estiver selecionado <strong>"N√ÉO"</strong> os campos ser√£o bloqueados</li>
                        <li>‚úÖ Em ambos os casos, os arquivos PDF e CSV/Excel/Libre Office Calc PODER√ÉO ser gerados (desde que a data esteja preenchida).</li>
                    </ul>
                </div>    

                <h3>üìÖ 5. Campos de Data com Calend√°rio Edit√°vel</h3>
                <p>Os campos de data possuem um componente edit√°vel:</p>
                <ul>
                    <li>Selecione a op√ß√£o <strong>"N/A"</strong> no dropdown √† esquerda caso o preenchimento deste campo n√£o seja aplic√°vel</li>
                    <li>Ou selecione a op√ß√£o <strong>"Data"</strong> e clique no campo para preencher a data no calend√°rio</li>
                </ul>

                <h3>üîß 6. Funcionalidades Dispon√≠veis</h3>
                <ul>
                    <li><strong>‚ûï Adicionar Linha:</strong> Este comando serve para inserir uma nova linha na tabela</li>
                    <li><strong>üóëÔ∏è Remover Selecionadas:</strong> Este comando serve para excluir linhas marcadas</li>
                    <li><strong>üîÄ Ordena√ß√£o Avan√ßada:</strong> Este comando serve para ordenar por at√© 3 campos</li>
                    <li><strong>üìä Exportar Arquivo:</strong> Este comando serve para gerar um arquivo no formato CSV/Excel/Libre Office Calc para posterior envio √† Remunera√ß√£o e Performance</li>
                </ul>

                <h3>üìÑ 7. Gera√ß√£o dos Arquivos</h3>
                <strong>‚ö†Ô∏è IMPORTANTE - Campos Obrigat√≥rios:</strong>
                    <p style="margin-top: 8px;">Os seguintes campos dever√£o estar preenchidos para gera√ß√£o do arquivo, seja em PDF ou CSV/Excel/Libre Office Calc:</p>
                    <ul style="margin-top: 8px;">
                        <li>Nome do Respons√°vel e Empresa</li>
                        <li>Matr√≠cula, Nome Completo, Setor de Origem, Cargo Atual</li>
                        <li>C√≥d. Setor Destino (10 d√≠gitos), Setor de Destino, Cargo Proposto</li>
                        <li>Cargo Proposto √© de Lideran√ßa?, Em Treinamento?, Possui Carta?</li>
                        <li>Se "√â Substitui√ß√£o?" = SIM: Matr√≠cula, Nome, Motivo e <strong>Data do Motivo</strong></li>
                    </ul>
                <div class="danger-box">
                    <strong>‚ùå BLOQUEIO: Lideran√ßa SIM + R&S N√ÉO</strong>
                    <p style="margin-top: 8px;">A gera√ß√£o dos arquivos estar√° <strong>BLOQUEADA</strong> se houver linhas com:</p>
                    <ul style="margin-top: 8px;">
                        <li>Cargo Proposto √© de Lideran√ßa? = <strong>SIM</strong></li>
                        <li>E R&S fez Avalia√ß√£o? = <strong>N√ÉO</strong></li>
                    </ul>
                    <p style="margin-top: 8px;"><strong>A√ß√£o necess√°ria:</strong> Retire esse candidato da lista e solicite a realiza√ß√£o da Avalia√ß√£o Comportamental √† R&S.</p>
                </div>
                
                <div class="danger-box">
                    <strong>‚ùå BLOQUEIO: Em Treinamento SIM + Carta N√ÉO</strong>
                    <p style="margin-top: 8px;">A gera√ß√£o dos arquivos estar√° <strong>BLOQUEADA</strong> se houver linhas com:</p>
                    <ul style="margin-top: 8px;">
                         <li>Em Treinamento? = <strong>SIM</strong></li>
                        <li>E Possui Carta? = <strong>N√ÉO</strong></li>
                    </ul>
                     <p style="margin-top: 8px;"><strong>A√ß√£o necess√°ria:</strong> Retire esse candidato da lista e regularize a carta de treinamento junto √† Ger√™ncia do DP.</p>
                </div>


                <h3>üí° Atalhos de Teclado</h3>
                <div class="success-box">
                    <span class="keyboard-shortcut">Ctrl + M</span> Este comando acrescentar√° uma nova linha<br>
                    <span class="keyboard-shortcut">Ctrl + P</span> Este comando permitir√° gerar um arquivo no formado PDF<br>
                    <span class="keyboard-shortcut">Ctrl + E</span> Este comando permitir√° gerar um arquivo no formato CSV/Excel/Libre Office Calc<br>
                    <span class="keyboard-shortcut">F1</span> Este comando permitir√° que voc√™ "selecione" este menu com as Instru√ß√µes de preenchimento da Tabela de Indica√ß√µes para o Comit√™.<br>
                    <span class="keyboard-shortcut">Setas</span> Este comando permitir√° que voc√™ navegue na tabela
                </div>

                <h3>üìß 8. Envio para Remunera√ß√£o e Performance</h3>
                <div class="info-box">
                    <p><strong>Ap√≥s gerar os dois arquivos nos formatos especificados, localize-os na pasta de Downloads, e os envie por e-mail ao Respons√°vel de Remunera√ß√£o e Performance, mantendo em c√≥pia o Gerente da √Årea demandante e sua Superintend√™ncia, conforme os passos abaixo:</strong></p>
                    <ul style="margin-top: 8px;">
                        <li>Abra seu cliente de e-mail corporativo (Thunderbird, Outlook, Gmail, etc.)</li>
                        <li>Crie um novo e-mail, tendo como destinat√°rio o Respons√°vel de Remunera√ß√£o e Performance</li>
                        <li>Inclua <strong>obrigatoriamente na c√≥pia (Cc)</strong>, o Gerente da √Årea demandante e sua Superintend√™ncia</li>
                        <li>Anexe os arquivos gerados:</li>
                        <li>‚úÖ Arquivo no formato <strong>PDF</strong> (para visualiza√ß√£o)</li>
                        <li>‚úÖ Arquivo no formato <strong>CSV/Excel/Libre Office Calc</strong> (para processamento)</li>
                        <li>Revise todos os dados antes de enviar</li>
                    </ul>
                    <p style="margin-top: 10px; color: #b00020; font-weight: bold;">
                        ‚ö†Ô∏è ATEN√á√ÉO: O envio do e-mail <u>n√£o ser√° aceito</u> e <u>n√£o ser√° considerado v√°lido</u> caso o Gerente da √Årea demandante e sua Superintend√™ncia <u>n√£o estejam obrigatoriamente inclusos na c√≥pia (CC)</u>.
                    </p>
                    <p style="margin-top: 8px;"><strong>Assunto sugerido:</strong> "Indica√ß√µes para o Comit√™ - [M√™s] / [Ano]"</p>
                </div>

                <div class="highlight">
                    <strong>Modelo de E-mail:</strong><br><br>
                    <em>Ao Respons√°vel de Remunera√ß√£o e Performance,</em><br><br>
                    <em>Estamos enviando em anexo, a Tabela de Indica√ß√µes para o Comit√™ com as propostas de promo√ß√µes/transfer√™ncias referentes ao per√≠odo [M√™s/Ano].</em><br><br>
                    <em>Total de indica√ß√µes: [n√∫mero]</em><br><br>
                    <em>Fico √† disposi√ß√£o para esclarecimentos.</em><br><br>
                    <em>Atenciosamente,<br>[Seu Nome]</em>
                </div>

                 <h3>‚ùì 9. D√∫vidas e Suporte</h3>
                <p>Em caso de d√∫vidas, entre em contato com Remunera√ß√£o e Performance.</p>

            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeInstructions()">Entendi, Fechar</button>
            </div>
        </div>
    </div>

    <div id="saveIndicator">üíæ Dados salvos automaticamente</div>

    <div id="startupModal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-header">
                <h2 style="justify-content: center;">üìã Dados Encontrados</h2>
            </div>
            <div class="modal-body">
                <p style="font-size: 16px;">Detectamos um preenchimento anterior n√£o finalizado.<br>Como deseja prosseguir?</p>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px;">
                <button class="btn btn-danger" onclick="askStartupClear()">LIMPAR TABELA</button>
                <button class="btn btn-success" onclick="askStartupContinue()">SIM, CONTINUAR</button>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let rowCounter = 0;
        let currentSortField = '';
        let currentSortOrder = 'asc';
        let currentEditingCell = null;
        let pendingConfirmAction = null; // Vari√°vel para armazenar a a√ß√£o de confirma√ß√£o pendente

        // Inicializar com carregamento de dados
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // ============================================
        // FUN√á√ïES DE AUTO-SAVE (LOCALSTORAGE)
        // ============================================
        function saveData() {
            const responsavel = document.getElementById('responsavel').value;
            const empresa = document.getElementById('empresa').value;
            const rows = [];

            document.querySelectorAll('#tableBody tr').forEach(tr => {
                const rowData = {};
                tr.querySelectorAll('input, select').forEach(input => {
                    // Ignora checkbox
                    if(input.type === 'checkbox') return;
                    
                    // Salva valor
                    if (input.dataset.field) {
                        rowData[input.dataset.field] = input.value;
                    } else if (input.dataset.fieldSelect) {
                        rowData[input.dataset.fieldSelect + '_select'] = input.value;
                    }
                });
                rows.push(rowData);
            });

            const dataToSave = {
                responsavel: responsavel,
                empresa: empresa,
                rows: rows
            };

            localStorage.setItem('tabelaIndicacoesData', JSON.stringify(dataToSave));
            showSaveIndicator();
        }

        function loadData() {
            const savedData = localStorage.getItem('tabelaIndicacoesData');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // Restaurar cabe√ßalho
                    if(data.responsavel) document.getElementById('responsavel').value = data.responsavel;
                    if(data.empresa) document.getElementById('empresa').value = data.empresa;

                    // Restaurar linhas
                    const tbody = document.getElementById('tableBody');
                    tbody.innerHTML = ''; // Limpa tabela atual
                    rowCounter = 0;

                    if (data.rows && data.rows.length > 0) {
                        data.rows.forEach(rowData => {
                            addRow(rowData); // Passa os dados para a fun√ß√£o addRow
                        });
                    } else {
                        for (let i = 0; i < 3; i++) addRow();
                    }

                    // --- IN√çCIO DA MODIFICA√á√ÉO: Exibir Modal de Startup ---
                    document.getElementById('startupModal').classList.add('show');
                    // --- FIM DA MODIFICA√á√ÉO ---

                } catch (e) {
                    console.error("Erro ao carregar dados", e);
                    for (let i = 0; i < 3; i++) addRow();
                }
            } else {
                // Primeira vez: 3 linhas vazias
                for (let i = 0; i < 3; i++) addRow();
            }
        }

        // --- NOVAS FUN√á√ïES PARA O FLUXO DE INICIALIZA√á√ÉO ---
        
        function closeStartupModal() {
            document.getElementById('startupModal').classList.remove('show');
        }

        function handleStartupClear() {
            // Fecha o modal
            closeStartupModal();
            
            // EXECUTA A MESMA L√ìGICA DO BOT√ÉO "LIMPAR TABELA"
            // (Replica√ß√£o da l√≥gica interna de limpeza para evitar redund√¢ncia de confirma√ß√£o)
            localStorage.removeItem('tabelaIndicacoesData');
            document.getElementById('responsavel').value = '';
            document.getElementById('empresa').value = '';
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            rowCounter = 0;
            for (let i = 0; i < 3; i++) {
                addRow();
            }
            // Feedback visual opcional
            showCustomAlert('Tabela Limpa', 'Uma nova tabela foi iniciada.');
        }

        // ============================================================
        // FLUXO DE DECIS√ÉO DE INICIALIZA√á√ÉO (2¬™ ETAPA DE CONFIRMA√á√ÉO)
        // ============================================================

        // Helper: Restaura o comportamento padr√£o do bot√£o "Cancelar" do modal de confirma√ß√£o
        function resetCancelButton() {
            const cancelBtn = document.querySelector('#customConfirmModal .btn-danger');
            // Restaura o onclick original do HTML/Script
            cancelBtn.onclick = function() { closeCustomConfirm(); };
        }

        // Helper: Configura o bot√£o "Cancelar" para voltar ao Modal de Startup (Estado Anterior)
        function setupCancelToReturn() {
            const cancelBtn = document.querySelector('#customConfirmModal .btn-danger');
            cancelBtn.onclick = function() {
                closeCustomConfirm(); // Fecha o modal de "Tem certeza?"
                document.getElementById('startupModal').classList.add('show'); // Reabre o modal de "Escolha"
                resetCancelButton(); // Limpa o override para n√£o afetar o resto do sistema
            };
        }

        // 1. Fluxo: Usu√°rio clicou em LIMPAR TABELA
        function askStartupClear() {
            // Oculta o modal inicial temporariamente
            document.getElementById('startupModal').classList.remove('show');
            
            // Configura o bot√£o "Cancelar" para voltar atr√°s
            setupCancelToReturn();

            // Exibe a confirma√ß√£o usando o modal padr√£o do sistema
            showCustomConfirm(
                'Confirma√ß√£o de Limpeza',
                'Tem certeza que deseja limpar os dados da tabela?\nEsta a√ß√£o apagar√° o progresso salvo.',
                function() {
                    handleStartupClear(); // Executa a l√≥gica original de limpeza
                    resetCancelButton();  // Restaura o bot√£o cancelar para o padr√£o
                }
            );
        }

        // 2. Fluxo: Usu√°rio clicou em SIM, CONTINUAR
        function askStartupContinue() {
            // Oculta o modal inicial temporariamente
            document.getElementById('startupModal').classList.remove('show');

            // Configura o bot√£o "Cancelar" para voltar atr√°s
            setupCancelToReturn();

            // Exibe a confirma√ß√£o
            showCustomConfirm(
                'Continuar Preenchimento',
                'Tem certeza que deseja continuar preenchendo os dados existentes?',
                function() {
                    closeStartupModal(); // Fecha definitivamente o fluxo de startup
                    resetCancelButton(); // Restaura o bot√£o cancelar para o padr√£o
                }
            );
        }

        function clearAllData() {
            showCustomConfirm('‚ö†Ô∏è ATEN√á√ÉO', 'Tem certeza que deseja limpar TODOS os dados da tabela e come√ßar do zero?', function() {
                localStorage.removeItem('tabelaIndicacoesData');
                document.getElementById('responsavel').value = '';
                document.getElementById('empresa').value = '';
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                rowCounter = 0;
                for (let i = 0; i < 3; i++) {
                    addRow();
                }
                showCustomAlert('Limpeza Conclu√≠da', 'Todos os dados foram apagados e a tabela foi reiniciada.');
            });
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }

        // ============================================
        // FUN√á√ÉO CENTRAL DE ESTILO DE ERRO NA LINHA
        // ============================================
        function updateRowErrorState(row) {
            // Verifica se existe ALGUM campo com a classe 'error' nesta linha
            if (row.querySelector('.error')) {
                row.classList.add('row-error'); // Pinta a linha de vermelho
            } else {
                row.classList.remove('row-error'); // Remove o vermelho se n√£o houver erros
            }
        }

        // ============================================
        // VALIDA√á√ÉO DE MATR√çCULAS DUPLICADAS (VISUAL)
        // ============================================
        function checkAllMatriculas() {
            const allRows = document.querySelectorAll('#tableBody tr');
            const matriculaCounts = {};
            const inputs = [];

            // 1. Contar ocorr√™ncias
            allRows.forEach(row => {
                const input = row.querySelector('[data-field="matricula"]');
                if (input && input.value.trim() !== '') {
                    const val = input.value.trim();
                    matriculaCounts[val] = (matriculaCounts[val] || 0) + 1;
                    inputs.push({ input: input, val: val, row: row });
                } else if (input) {
                    if (!input.classList.contains('numeric-error')) {
                        input.classList.remove('error');
                        input.title = '';
                    }
                    updateRowErrorState(row);
                }
            });

            // 2. Aplicar erro visual
            inputs.forEach(item => {
                if (matriculaCounts[item.val] > 1) {
                    item.input.classList.add('error');
                    item.input.title = 'Matr√≠cula duplicada!';
                } else {
                    if (/^\d+$/.test(item.val)) {
                        item.input.classList.remove('error');
                        item.input.classList.remove('numeric-error');
                        item.input.title = '';
                    }
                }
                updateRowErrorState(item.row);
            });
        }

        // ============================================
        // FUN√á√ïES PARA O ALERTA E CONFIRMA√á√ÉO PERSONALIZADOS
        // ============================================
        function showCustomAlert(title, message) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('customAlertModal').classList.add('show');
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').classList.remove('show');
        }

        function showCustomConfirm(title, message, callback) {
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            pendingConfirmAction = callback;
            document.getElementById('customConfirmModal').classList.add('show');
        }

        function closeCustomConfirm() {
            document.getElementById('customConfirmModal').classList.remove('show');
            pendingConfirmAction = null;
        }

        // Adicionar listener para o bot√£o de confirmar no modal
        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            if (pendingConfirmAction) {
                pendingConfirmAction();
            }
            closeCustomConfirm();
        });

        // Adicionar nova linha (Modificada para receber dados e salvar)
        function addRow(data = null) {
            rowCounter++;
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();
            row.id = `row-${rowCounter}`;
            
            // Helper para valor seguro
            const v = (field) => data && data[field] ? data[field] : '';
            const vs = (field) => data && data[field] ? data[field] : ''; // Select value

            row.innerHTML = `
                <td class="checkbox-cell"><input type="checkbox" class="row-checkbox"></td>
                <td><input type="text" class="cell-input" data-field="matricula" value="${v('matricula')}" placeholder="Matr√≠cula" onblur="validateMatricula(this)" oninput="this.value = this.value.replace(/[^0-9]/g, ''); checkAllMatriculas(); saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="nome" value="${v('nome')}" placeholder="Nome Completo" oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="setorOrigem" value="${v('setorOrigem')}" placeholder="Ex: Setor 24" oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="cargoAtual" value="${v('cargoAtual')}" placeholder="Ex: Costureira" oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="codSetorDestino" value="${v('codSetorDestino')}" placeholder="10 d√≠gitos" maxlength="14" onblur="formatCodSetor(this)" oninput="validateCodSetorInput(this); saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="setorDestino" value="${v('setorDestino')}" placeholder="Ex: Setor 17" oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="cargoProposto" value="${v('cargoProposto')}" placeholder="Ex: Aux. Admin." oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td>
                    <select class="cell-select" data-field="cargoLideranca" onchange="handleCargoLiderancaChange(this); saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="N/A" ${v('cargoLideranca') === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="SIM" ${v('cargoLideranca') === 'SIM' ? 'selected' : ''}>SIM</option>
                        <option value="N√ÉO" ${v('cargoLideranca') === 'N√ÉO' ? 'selected' : ''}>N√ÉO</option>
                    </select>
                </td>
                <td>
                    <select class="cell-select" data-field="avaliacaoComportamental" onchange="validateLeadershipEvaluation(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="N/A" ${v('avaliacaoComportamental') === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="SIM" ${v('avaliacaoComportamental') === 'SIM' ? 'selected' : ''}>SIM</option>
                        <option value="N√ÉO" ${v('avaliacaoComportamental') === 'N√ÉO' ? 'selected' : ''}>N√ÉO</option>
                    </select>
                </td>
                <td>
                    <div class="date-hybrid-wrapper">
                        <select class="date-hybrid-select" data-field-select="dataAvaliacaoComp" onchange="toggleDateField(this); validateLeadershipEvaluation(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                            <option value="data" ${data && data['dataAvaliacaoComp_select'] === 'data' ? 'selected' : ''}>Data</option>
                            <option value="na" ${data && data['dataAvaliacaoComp_select'] === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                        <input type="date" class="date-hybrid-input" data-field="dataAvaliacaoComp" value="${v('dataAvaliacaoComp')}" onchange="validateLeadershipEvaluation(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                    </div>
                </td>
                <td>
                    <select class="cell-select" data-field="emTreinamento" onchange="handleEmTreinamentoChange(this); saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="N/A" ${v('emTreinamento') === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="SIM" ${v('emTreinamento') === 'SIM' ? 'selected' : ''}>SIM</option>
                        <option value="N√ÉO" ${v('emTreinamento') === 'N√ÉO' ? 'selected' : ''}>N√ÉO</option>
                    </select>
                </td>
                <td>
                    <select class="cell-select" data-field="possuiCarta" onchange="validateTrainingAndCert(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="N/A" ${v('possuiCarta') === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="SIM" ${v('possuiCarta') === 'SIM' ? 'selected' : ''}>SIM</option>
                        <option value="N√ÉO" ${v('possuiCarta') === 'N√ÉO' ? 'selected' : ''}>N√ÉO</option>
                    </select>
                </td>
                <td>
                    <div class="date-hybrid-wrapper">
                        <select class="date-hybrid-select" data-field-select="dataInicio" onchange="toggleDateField(this); validateTrainingAndCert(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                            <option value="data" ${data && data['dataInicio_select'] === 'data' ? 'selected' : ''}>Data</option>
                            <option value="na" ${data && data['dataInicio_select'] === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                        <input type="date" class="date-hybrid-input" data-field="dataInicio" value="${v('dataInicio')}" onchange="validateTrainingAndCert(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                    </div>
                </td>
                <td>
                    <select class="cell-select" data-field="ehSubstituicao" onchange="handleEhSubstituicaoChange(this); saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="SIM" ${v('ehSubstituicao') === 'SIM' ? 'selected' : ''}>SIM</option>
                        <option value="N√ÉO" ${v('ehSubstituicao') === 'N√ÉO' ? 'selected' : ''}>N√ÉO</option>
                    </select>
                </td>
                <td><input type="text" class="cell-input" data-field="matriculaSubstituto" value="${v('matriculaSubstituto')}" placeholder="Matr√≠cula" onblur="validateMatricula(this)" oninput="this.value = this.value.replace(/[^0-9]/g, ''); saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td><input type="text" class="cell-input" data-field="nomeSubstituto" value="${v('nomeSubstituto')}" placeholder="Nome Substitu√≠do" oninput="saveData()" onkeydown="handleCellKeydown(event)"></td>
                <td>
                    <select class="cell-select" data-field="motivoSubstituicao" onchange="saveData()" onkeydown="handleCellKeydown(event)">
                        <option value="">-</option>
                        <option value="N/A" ${v('motivoSubstituicao') === 'N/A' ? 'selected' : ''}>N/A</option>
                        <option value="PROMO√á√ÉO" ${v('motivoSubstituicao') === 'PROMO√á√ÉO' ? 'selected' : ''}>PROMO√á√ÉO</option>
                        <option value="DESLIGAMENTO" ${v('motivoSubstituicao') === 'DESLIGAMENTO' ? 'selected' : ''}>DESLIGAMENTO</option>
                        <option value="TRANSFER√äNCIA" ${v('motivoSubstituicao') === 'TRANSFER√äNCIA' ? 'selected' : ''}>TRANSFER√äNCIA</option>
                    </select>
                </td>
                <td>
                    <div class="date-hybrid-wrapper">
                        <select class="date-hybrid-select" data-field-select="dataDesligamento" onchange="toggleDateField(this); validateSubstitution(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                            <option value="data" ${data && data['dataDesligamento_select'] === 'data' ? 'selected' : ''}>Data</option>
                            <option value="na" ${data && data['dataDesligamento_select'] === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                        <input type="date" class="date-hybrid-input" data-field="dataDesligamento" value="${v('dataDesligamento')}" onchange="validateSubstitution(this.closest('tr')); saveData()" onkeydown="handleCellKeydown(event)">
                    </div>
                </td>
            `;

            // Inicializar estados com base nos dados carregados
            if (data) {
                // Configurar Data/N/A
                const dateWrappers = row.querySelectorAll('.date-hybrid-wrapper');
                dateWrappers.forEach(wrapper => {
                    const select = wrapper.querySelector('select');
                    toggleDateField(select);
                });

                // Habilitar/desabilitar campos dependentes
                const cargoLiderancaSelect = row.querySelector('[data-field="cargoLideranca"]');
                handleCargoLiderancaChange(cargoLiderancaSelect);

                const emTreinamentoSelect = row.querySelector('[data-field="emTreinamento"]');
                handleEmTreinamentoChange(emTreinamentoSelect);

                const ehSubstituicaoSelect = row.querySelector('[data-field="ehSubstituicao"]');
                handleEhSubstituicaoChange(ehSubstituicaoSelect);
            }
        }

        // Navega√ß√£o com Teclado
        function handleCellKeydown(event) {
            const cell = event.target.closest('td');
            const row = cell.closest('tr');
            const cells = row.querySelectorAll('td:not(.checkbox-cell)');
            const currentCellIndex = Array.from(cells).indexOf(cell);

            if (event.key === 'ArrowRight' || (event.key === 'Enter' && !event.target.matches('textarea'))) {
                event.preventDefault();
                const nextCell = cells[currentCellIndex + 1];
                if (nextCell) {
                    const input = nextCell.querySelector('input, select');
                    if (input) input.focus();
                }
            } else if (event.key === 'ArrowLeft') {
                event.preventDefault();
                const prevCell = cells[currentCellIndex - 1];
                if (prevCell) {
                    const input = prevCell.querySelector('input, select');
                    if (input) input.focus();
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    const nextCells = nextRow.querySelectorAll('td:not(.checkbox-cell)');
                    const input = nextCells[currentCellIndex]?.querySelector('input, select');
                    if (input) input.focus();
                }
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                const prevRow = row.previousElementSibling;
                if (prevRow) {
                    const prevCells = prevRow.querySelectorAll('td:not(.checkbox-cell)');
                    const input = prevCells[currentCellIndex]?.querySelector('input, select');
                    if (input) input.focus();
                }
            }
        }

        function validateCodSetorInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length > 10) {
                input.value = input.value.substring(0, 10);
            }
            validateCodSetor(input);
        }

        function validateCodSetor(input) {
            const value = input.value.replace(/\D/g, '');
            if (value.length > 0 && value.length !== 10) {
                input.classList.add('error');
                input.title = 'O C√≥d. Setor Destino deve conter exatamente 10 d√≠gitos';
                return false;
            } else {
                input.classList.remove('error');
                input.title = '';
                return true;
            }
        }

        function formatCodSetor(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length === 10) {
                const formatted = value.substring(0, 4) + '.' +
                                  value.substring(4, 5) + '.' +
                                  value.substring(5, 6) + '.' +
                                  value.substring(6, 7) + '.' +
                                  value.substring(7, 8) + '.' +
                                  value.substring(8, 10);
                input.value = formatted;
                input.classList.remove('error');
                input.title = '';
            } else if (value.length > 0) {
                input.classList.add('error');
                input.title = 'O C√≥d. Setor Destino deve conter exatamente 10 d√≠gitos';
            }
        }

        function handleCargoLiderancaChange(selectElement) {
            const row = selectElement.closest('tr');
            const avaliacaoSelect = row.querySelector('[data-field="avaliacaoComportamental"]');
            const dataAvaliacaoSelect = row.querySelector('[data-field-select="dataAvaliacaoComp"]');
            const dataAvaliacaoInput = row.querySelector('[data-field="dataAvaliacaoComp"]');

            if (selectElement.value === 'N/A' || selectElement.value === 'N√ÉO') {
                avaliacaoSelect.disabled = true;
                avaliacaoSelect.value = '';
                avaliacaoSelect.classList.remove('error', 'warning');
                dataAvaliacaoSelect.disabled = true;
                dataAvaliacaoInput.disabled = true;
                dataAvaliacaoInput.value = '';
                dataAvaliacaoInput.classList.remove('error'); // Limpa erro se desabilitado
                updateRowErrorState(row);
            } else if (selectElement.value === 'SIM') {
                avaliacaoSelect.disabled = false;
                dataAvaliacaoSelect.disabled = false;
                if (dataAvaliacaoSelect.value === 'data') {
                    dataAvaliacaoInput.disabled = false;
                }
                validateLeadershipEvaluation(row);
            }
        }

        // ============================================
        // VALIDA√á√ÉO LIDERAN√áA (DESTAQUE VERMELHO)
        // ============================================
        function validateLeadershipEvaluation(row) {
            const cargoLideranca = row.querySelector('[data-field="cargoLideranca"]').value;
            const avaliacaoComport = row.querySelector('[data-field="avaliacaoComportamental"]');
            const dataAvalSelect = row.querySelector('[data-field-select="dataAvaliacaoComp"]');
            const dataAvalInput = row.querySelector('[data-field="dataAvaliacaoComp"]');

            // Resetar erros espec√≠ficos deste grupo
            avaliacaoComport.classList.remove('error');
            dataAvalInput.classList.remove('error');
            avaliacaoComport.title = '';

            // 1. Regra: Lideran√ßa SIM + Avalia√ß√£o N√ÉO
            if (cargoLideranca === 'SIM' && avaliacaoComport.value === 'N√ÉO') {
                avaliacaoComport.classList.add('error');
                avaliacaoComport.title = 'BLOQUEADO: Avalia√ß√£o Comportamental √© obrigat√≥ria para cargos de lideran√ßa!';
            }
            
            // 2. Regra NOVA: Lideran√ßa SIM + Avalia√ß√£o SIM -> Data Obrigat√≥ria
            if (cargoLideranca === 'SIM' && avaliacaoComport.value === 'SIM') {
                if (dataAvalSelect.value !== 'data' || !dataAvalInput.value) {
                    dataAvalInput.classList.add('error');
                    dataAvalInput.title = 'Data da Avalia√ß√£o √© obrigat√≥ria!';
                }
            }

            updateRowErrorState(row);
        }

        function handleEmTreinamentoChange(selectElement) {
            const row = selectElement.closest('tr');
            const possuiCartaSelect = row.querySelector('[data-field="possuiCarta"]');
            const dataInicioSelect = row.querySelector('[data-field-select="dataInicio"]');
            const dataInicioInput = row.querySelector('[data-field="dataInicio"]');

            if (selectElement.value === 'N/A' || selectElement.value === 'N√ÉO') {
                possuiCartaSelect.disabled = true;
                possuiCartaSelect.value = '';
                possuiCartaSelect.classList.remove('warning', 'error');
                dataInicioSelect.disabled = true;
                dataInicioInput.disabled = true;
                dataInicioInput.value = '';
                dataInicioInput.classList.remove('error'); // Limpa erro
                updateRowErrorState(row);
            } else {
                possuiCartaSelect.disabled = false;
                dataInicioSelect.disabled = false;
                if (dataInicioSelect.value === 'data') {
                    dataInicioInput.disabled = false;
                }
                validateTrainingAndCert(row);
            }
        }

        // ============================================
        // VALIDA√á√ÉO TREINAMENTO (DESTAQUE VERMELHO)
        // ============================================
        function validateTrainingAndCert(row) {
            // Aceita tanto o elemento select quanto a row, garantindo compatibilidade
            if (row.tagName !== 'TR') row = row.closest('tr');

            const emTreinamento = row.querySelector('[data-field="emTreinamento"]').value;
            const possuiCarta = row.querySelector('[data-field="possuiCarta"]');
            const dataInicioSelect = row.querySelector('[data-field-select="dataInicio"]');
            const dataInicioInput = row.querySelector('[data-field="dataInicio"]');

            // Resetar erros
            possuiCarta.classList.remove('error', 'warning');
            dataInicioInput.classList.remove('error');
            possuiCarta.title = '';

            // 1. Regra: Treinamento SIM + Carta N√ÉO
            if (emTreinamento === 'SIM' && (possuiCarta.value === 'N√ÉO' || possuiCarta.value === 'N/A')) {
                possuiCarta.classList.add('error');
                possuiCarta.title = 'BLOQUEADO: Empregado em treinamento sem carta.';
            }

            // 2. Regra NOVA: Treinamento SIM + Carta SIM -> Data Obrigat√≥ria
            if (emTreinamento === 'SIM' && possuiCarta.value === 'SIM') {
                if (dataInicioSelect.value !== 'data' || !dataInicioInput.value) {
                    dataInicioInput.classList.add('error');
                    dataInicioInput.title = 'Data de In√≠cio do Treinamento √© obrigat√≥ria!';
                }
            }

            updateRowErrorState(row);
        }

        function handleEhSubstituicaoChange(selectElement) {
            const row = selectElement.closest('tr');
            const matriculaSubstInput = row.querySelector('[data-field="matriculaSubstituto"]');
            const nomeSubstInput = row.querySelector('[data-field="nomeSubstituto"]');
            const motivoSelect = row.querySelector('[data-field="motivoSubstituicao"]');
            const dataDesligSelect = row.querySelector('[data-field-select="dataDesligamento"]');
            const dataDesligInput = row.querySelector('[data-field="dataDesligamento"]');

            if (selectElement.value === 'N√ÉO') {
                matriculaSubstInput.disabled = true;
                matriculaSubstInput.value = '';
                nomeSubstInput.disabled = true;
                nomeSubstInput.value = '';
                motivoSelect.disabled = true;
                motivoSelect.value = '';
                dataDesligSelect.disabled = true;
                dataDesligInput.disabled = true;
                dataDesligInput.value = '';
                dataDesligInput.classList.remove('error'); // Limpa erro
                updateRowErrorState(row);
            } else {
                matriculaSubstInput.disabled = false;
                nomeSubstInput.disabled = false;
                motivoSelect.disabled = false;
                dataDesligSelect.disabled = false;
                if (dataDesligSelect.value === 'data') {
                    dataDesligInput.disabled = false;
                }
                validateSubstitution(row);
            }
        }

        // ============================================
        // VALIDA√á√ÉO SUBSTITUI√á√ÉO (NOVA)
        // ============================================
        function validateSubstitution(row) {
            const ehSubstituicao = row.querySelector('[data-field="ehSubstituicao"]').value;
            const dataDesligSelect = row.querySelector('[data-field-select="dataDesligamento"]');
            const dataDesligInput = row.querySelector('[data-field="dataDesligamento"]');

            dataDesligInput.classList.remove('error');

            if (ehSubstituicao === 'SIM') {
                if (dataDesligSelect.value !== 'data' || !dataDesligInput.value) {
                    dataDesligInput.classList.add('error');
                    dataDesligInput.title = 'Data do Motivo da Substitui√ß√£o √© obrigat√≥ria!';
                }
            }
            updateRowErrorState(row);
        }

        function toggleDateField(selectElement) {
            const wrapper = selectElement.parentElement;
            const dateInput = wrapper.querySelector('.date-hybrid-input');

            if (selectElement.value === 'na') {
                dateInput.disabled = true;
                dateInput.value = '';
                dateInput.dataset.naValue = 'N/A';
            } else {
                if (!selectElement.disabled) {
                    dateInput.disabled = false;
                }
                delete dateInput.dataset.naValue;
            }
        }

        function convertDateForDisplay(dateValue) {
            if (!dateValue) return '';
            const parts = dateValue.split('-');
            if (parts.length !== 3) return dateValue;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function getDateFieldValue(dateInput) {
            if (dateInput.dataset.naValue === 'N/A') {
                return 'N/A';
            }
            return dateInput.value;
        }

        function getMatriculaComEmpresa(matriculaValue) {
            const empresa = document.getElementById('empresa').value;
            if (!empresa || !matriculaValue) return matriculaValue;
            return `${empresa}-${matriculaValue}`;
        }

        function validateMatricula(input) {
            const value = input.value.trim();
            // Valida√ß√£o de formato (N√∫meros) - Seguran√ßa adicional
            if (value && !/^\d+$/.test(value)) {
                input.classList.add('error');
                input.classList.add('numeric-error');
                input.title = 'A matr√≠cula deve conter apenas n√∫meros';
            } else {
                if(input.classList.contains('numeric-error')) {
                    input.classList.remove('error');
                    input.classList.remove('numeric-error');
                    input.title = '';
                }
            }
            // Chama a valida√ß√£o de duplicidade global
            checkAllMatriculas();
        }

        // ============================================
        // FUN√á√ïES DE VERIFICA√á√ÉO (RETORNAM LISTA DE ERROS)
        // ============================================

        function checkLeadershipBlock() {
            const rows = document.querySelectorAll('#tableBody tr');
            const blockedList = [];

            rows.forEach((row, index) => {
                const matricula = row.querySelector('[data-field="matricula"]').value.trim();
                if (!matricula) return;

                const cargoLideranca = row.querySelector('[data-field="cargoLideranca"]').value;
                const avaliacaoComport = row.querySelector('[data-field="avaliacaoComportamental"]').value;
                const nome = row.querySelector('[data-field="nome"]').value;

                // Bloqueio 1: Lideran√ßa=SIM e Avalia√ß√£o=N√ÉO
                if (cargoLideranca === 'SIM' && avaliacaoComport === 'N√ÉO') {
                    blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Avalia√ß√£o pendente)`);
                }
            });
            return blockedList;
        }

        function checkTrainingBlock() {
            const rows = document.querySelectorAll('#tableBody tr');
            const blockedList = [];

            rows.forEach((row, index) => {
                const matricula = row.querySelector('[data-field="matricula"]').value.trim();
                if (!matricula) return;

                const emTreinamento = row.querySelector('[data-field="emTreinamento"]').value;
                const possuiCarta = row.querySelector('[data-field="possuiCarta"]').value;
                const nome = row.querySelector('[data-field="nome"]').value;

                // Bloqueio 1: Treinamento=SIM e Carta=N√ÉO/NA
                if (emTreinamento === 'SIM' && (possuiCarta === 'N√ÉO' || possuiCarta === 'N/A')) {
                    blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Carta pendente)`);
                }
            });
            return blockedList;
        }

        function checkMissingDatesBlock() {
            const rows = document.querySelectorAll('#tableBody tr');
            const blockedList = [];

            rows.forEach((row, index) => {
                const matricula = row.querySelector('[data-field="matricula"]').value.trim();
                if (!matricula) return;
                const nome = row.querySelector('[data-field="nome"]').value;

                // 1. Data Avalia√ß√£o Lideran√ßa
                const cargoLideranca = row.querySelector('[data-field="cargoLideranca"]').value;
                const avaliacaoComport = row.querySelector('[data-field="avaliacaoComportamental"]').value;
                const dataAvalSelect = row.querySelector('[data-field-select="dataAvaliacaoComp"]').value;
                const dataAvalInput = row.querySelector('[data-field="dataAvaliacaoComp"]').value;

                if (cargoLideranca === 'SIM' && avaliacaoComport === 'SIM') {
                    if (dataAvalSelect !== 'data' || !dataAvalInput) {
                        blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Falta Data da Avalia√ß√£o)`);
                    }
                }

                // 2. Data In√≠cio Treinamento
                const emTreinamento = row.querySelector('[data-field="emTreinamento"]').value;
                const possuiCarta = row.querySelector('[data-field="possuiCarta"]').value;
                const dataInicioSelect = row.querySelector('[data-field-select="dataInicio"]').value;
                const dataInicioInput = row.querySelector('[data-field="dataInicio"]').value;

                if (emTreinamento === 'SIM' && possuiCarta === 'SIM') {
                    if (dataInicioSelect !== 'data' || !dataInicioInput) {
                        blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Falta Data In√≠cio Treinamento)`);
                    }
                }

                // 3. Data Substitui√ß√£o
                const ehSubstituicao = row.querySelector('[data-field="ehSubstituicao"]').value;
                const dataDesligSelect = row.querySelector('[data-field-select="dataDesligamento"]').value;
                const dataDesligInput = row.querySelector('[data-field="dataDesligamento"]').value;

                if (ehSubstituicao === 'SIM') {
                    if (dataDesligSelect !== 'data' || !dataDesligInput) {
                        blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Falta Data do Motivo da Substitui√ß√£o)`);
                    }
                }
            });
            return blockedList;
        }

        // NOVA FUN√á√ÉO: Verificar se alguma matr√≠cula cont√©m caracteres n√£o num√©ricos
        function checkNumericMatriculaBlock() {
            const rows = document.querySelectorAll('#tableBody tr');
            const blockedList = [];

            rows.forEach((row, index) => {
                const matricula = row.querySelector('[data-field="matricula"]').value;
                // Se n√£o estiver vazio e n√£o for apenas d√≠gitos
                if (matricula && !/^\d+$/.test(matricula)) {
                    const nome = row.querySelector('[data-field="nome"]').value;
                    blockedList.push(`‚Ä¢ Linha ${index + 1}: ${nome} (Matr√≠cula inv√°lida: "${matricula}")`);
                }
            });
            return blockedList;
        }

        function hasDuplicatedMatriculas() {
            const rows = document.querySelectorAll('#tableBody tr');
            const matriculas = [];
            const duplicates = [];

            rows.forEach((row, index) => {
                const matriculaInput = row.querySelector('[data-field="matricula"]');
                const matricula = matriculaInput.value.trim();
                
                if (matricula) {
                    if (matriculas.includes(matricula)) {
                        if (!duplicates.includes(matricula)) {
                            duplicates.push(matricula);
                        }
                    } else {
                        matriculas.push(matricula);
                    }
                }
            });

            if (duplicates.length > 0) {
                return { hasDuplicates: true, duplicatedValues: duplicates };
            }
            return { hasDuplicates: false };
        }

        function validateRequiredFields() {
            const errors = [];
            const responsavel = document.getElementById('responsavel').value.trim();
            const empresa = document.getElementById('empresa').value;
            
            if (!responsavel) errors.push('Nome do Respons√°vel');
            if (!empresa) errors.push('Selecione a Empresa');

            const rows = document.querySelectorAll('#tableBody tr');
            let rowNum = 0;
            
            rows.forEach((row, index) => {
                rowNum = index + 1;
                const matricula = row.querySelector('[data-field="matricula"]').value.trim();
                const nome = row.querySelector('[data-field="nome"]').value.trim();
                const setorOrigem = row.querySelector('[data-field="setorOrigem"]').value.trim();
                const cargoAtual = row.querySelector('[data-field="cargoAtual"]').value.trim();
                const codSetorDestinoInput = row.querySelector('[data-field="codSetorDestino"]');
                const codSetorDestino = codSetorDestinoInput.value.trim();
                const codSetorDestinoNumeros = codSetorDestino.replace(/\D/g, '');
                const setorDestino = row.querySelector('[data-field="setorDestino"]').value.trim();
                const cargoProposto = row.querySelector('[data-field="cargoProposto"]').value.trim();
                const cargoLideranca = row.querySelector('[data-field="cargoLideranca"]').value;
                const emTreinamento = row.querySelector('[data-field="emTreinamento"]').value;
                const possuiCarta = row.querySelector('[data-field="possuiCarta"]');
                const ehSubstituicao = row.querySelector('[data-field="ehSubstituicao"]').value;
                
                const hasData = matricula || nome || setorOrigem || cargoAtual || codSetorDestino || setorDestino || cargoProposto;
                
                if (hasData) {
                    if (!matricula) errors.push(`Linha ${rowNum}: Matr√≠cula`);
                    if (!nome) errors.push(`Linha ${rowNum}: Nome Completo`);
                    if (!setorOrigem) errors.push(`Linha ${rowNum}: Setor de Origem`);
                    if (!cargoAtual) errors.push(`Linha ${rowNum}: Cargo Atual`);
                    if (!codSetorDestino) {
                        errors.push(`Linha ${rowNum}: C√≥d. Setor Destino`);
                    } else if (codSetorDestinoNumeros.length !== 10) {
                        errors.push(`Linha ${rowNum}: C√≥d. Setor Destino (deve conter exatamente 10 d√≠gitos)`);
                        codSetorDestinoInput.classList.add('error');
                    }
                    if (!setorDestino) errors.push(`Linha ${rowNum}: Setor de Destino`);
                    if (!cargoProposto) errors.push(`Linha ${rowNum}: Cargo Proposto`);
                    if (!cargoLideranca) errors.push(`Linha ${rowNum}: Cargo Proposto √© de Lideran√ßa?`);
                    if (!emTreinamento) errors.push(`Linha ${rowNum}: Em Treinamento?`);
                    if (!possuiCarta.disabled && !possuiCarta.value) errors.push(`Linha ${rowNum}: Possui Carta?`);
                    if (ehSubstituicao === 'SIM') {
                        const matriculaSubst = row.querySelector('[data-field="matriculaSubstituto"]').value.trim();
                        const nomeSubst = row.querySelector('[data-field="nomeSubstituto"]').value.trim();
                        const motivoSubst = row.querySelector('[data-field="motivoSubstituicao"]').value;
                        
                        if (!matriculaSubst) errors.push(`Linha ${rowNum}: Matr√≠cula do Substitu√≠do`);
                        if (!nomeSubst) errors.push(`Linha ${rowNum}: Nome Completo do Substitu√≠do`);
                        if (!motivoSubst) errors.push(`Linha ${rowNum}: Motivo da Substitui√ß√£o`);
                    }
                }
            });
            return errors;
        }

        function removeSelectedRows() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', 'Selecione pelo menos uma linha para remover.');
                return;
            }
            
            showCustomConfirm('‚ö†Ô∏è ATEN√á√ÉO', `Deseja realmente remover ${checkboxes.length} linha(s)?`, function() {
                checkboxes.forEach(checkbox => {
                    checkbox.closest('tr').remove();
                });
                document.getElementById('selectAll').checked = false;
                checkAllMatriculas();
                saveData();
            });
        }

        function selectAllRows(checkbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function toggleSortPanel() {
            const panel = document.getElementById('sortPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function quickSort(field) {
            document.querySelectorAll('thead th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortOrder = 'asc';
            }
            currentSortField = field;

            sortTableByField(field, currentSortOrder);
            const clickedHeader = event.target;
            clickedHeader.classList.add(currentSortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }

        function applyAdvancedSort() {
            const sort1Field = document.getElementById('sort1Field').value;
            const sort1Order = document.getElementById('sort1Order').value;
            const sort2Field = document.getElementById('sort2Field').value;
            const sort2Order = document.getElementById('sort2Order').value;
            const sort3Field = document.getElementById('sort3Field').value;
            const sort3Order = document.getElementById('sort3Order').value;

            if (!sort1Field) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', 'Selecione pelo menos o 1¬∫ n√≠vel de ordena√ß√£o.');
                return;
            }

            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let result = compareValues(a, b, sort1Field, sort1Order);
                if (result !== 0) return result;

                if (sort2Field) {
                    result = compareValues(a, b, sort2Field, sort2Order);
                    if (result !== 0) return result;
                }

                if (sort3Field) {
                    result = compareValues(a, b, sort3Field, sort3Order);
                }

                return result;
            });

            rows.forEach(row => tbody.appendChild(row));
            
            document.querySelectorAll('thead th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
        }

        function clearSort() {
            document.getElementById('sort1Field').value = '';
            document.getElementById('sort2Field').value = '';
            document.getElementById('sort3Field').value = '';
            document.querySelectorAll('thead th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
        }

        function sortTableByField(field, order) {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => compareValues(a, b, field, order));
            rows.forEach(row => tbody.appendChild(row));
        }

        function compareValues(rowA, rowB, field, order) {
            let aVal = rowA.querySelector(`[data-field="${field}"]`)?.value || '';
            let bVal = rowB.querySelector(`[data-field="${field}"]`)?.value || '';

            if (field === 'matricula' || field === 'matriculaSubstituto') {
                aVal = parseInt(aVal) || 0;
                bVal = parseInt(bVal) || 0;
            } else {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            let result = 0;
            if (aVal < bVal) result = -1;
            if (aVal > bVal) result = 1;

            return order === 'asc' ? result : -result;
        }

        function exportCSV() {
            // VERIFICA√á√ÉO DE MATR√çCULAS COM LETRAS (SEGURAN√áA EXTRA)
            const invalidMatriculas = checkNumericMatriculaBlock();
            if (invalidMatriculas.length > 0) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: O campo matr√≠cula deve conter APENAS n√∫meros.\n\nPEND√äNCIAS:\n' + invalidMatriculas.join('\n') + '\n\nPor favor, corrija as matr√≠culas antes de prosseguir.');
                return;
            }

            const duplicateCheck = hasDuplicatedMatriculas();
            if (duplicateCheck.hasDuplicates) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem matr√≠culas duplicadas na tabela.\n\nMatr√≠culas repetidas: ' + duplicateCheck.duplicatedValues.join(', ') + '\n\nPor favor, corrija as matr√≠culas duplicadas antes de exportar o CSV/Excel/Libre Office Calc.');
                return;
            }

            const leadershipErrors = checkLeadershipBlock();
            if (leadershipErrors.length > 0) { 
                const listaNomes = leadershipErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existe(m) candidato(s) que no campo "Cargo √© de Lideran√ßa?" aparece(m) como SIM, e no campo "R&S fez Avalia√ß√£o?" figura(m) N√ÉO.\n\n' +
                    'CANDIDATO(S) COM PEND√äNCIA:\n' + listaNomes + '\n\n' +
                    'Esse(s) candidato(s) n√£o pode(m) ser movimentado(s) sem a "Avalia√ß√£o Comportamental" ter sido realizada por R & S.\n\n' +
                    'Por favor, retire-o(s) da lista a ser enviada para a √°rea de Remunera√ß√£o e Performance');
                return;
            }

            const trainingErrors = checkTrainingBlock();
            if (trainingErrors.length > 0) { 
                const listaNomes = trainingErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existe(m) candidato(s) que no campo "Em Treinamento?" aparece(m) como SIM, e no campo "Possui Carta?" figura(m) N√ÉO.\n\n' +
                    'CANDIDATO(S) COM PEND√äNCIA:\n' + listaNomes + '\n\n' +
                    'Esse(s) candidato(s) n√£o pode(m) ser movimentado(s) sem ter a Carta de Treinamento.\n\n' +
                    'Por favor, retire-o(s) da lista a ser enviada e contacte a Ger√™ncia do Departamento Pessoal para solicitar a elabora√ß√£o da carta de treinamento e coleta das assinaturas, considerando o tempo de forma√ß√£o de at√© 90 dias, antes da solicita√ß√£o de movimenta√ß√£o do empregado.');
                return;
            }

            const missingDateErrors = checkMissingDatesBlock();
            if (missingDateErrors.length > 0) {
                const listaNomes = missingDateErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem informa√ß√µes de data obrigat√≥rias faltando.\n\n' +
                    'PEND√äNCIAS:\n' + listaNomes + '\n\n' +
                    'Por favor, preencha as datas destacadas em vermelho antes de exportar.');
                return;
            }

            const errors = validateRequiredFields();
            if (errors.length > 0) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', 'Preencha os campos obrigat√≥rios antes de exportar:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '));
                return;
            }

            const responsavel = document.getElementById('responsavel').value;
            const empresaSelect = document.getElementById('empresa');
            const empresaText = empresaSelect.options[empresaSelect.selectedIndex].text;
            
            const headers = [
                'Matr√≠cula', 'Nome Completo', 'Setor Atual', 'Cargo Atual', 'C√≥d. Setor Destino',
                'Setor de Destino', 'Cargo Proposto', 'Cargo de Lideran√ßa?', 'R&S fez Avalia√ß√£o?',
                'Data Avalia√ß√£o Comportamental', 'Em Treinamento?', 'Possui Carta?',
                'Data In√≠cio Treinamento', '√â Substitui√ß√£o?', 'Matr√≠cula Substitu√≠do', 'Nome Substitu√≠do',
                'Motivo Substitui√ß√£o', 'Data Motivo Substitui√ß√£o'
            ];
            
            let csv = `Respons√°vel: ${responsavel}\nEmpresa: ${empresaText}\n\n`;
            csv += headers.join(';') + '\n';

            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const matricula = row.querySelector('[data-field="matricula"]').value;
                if (!matricula) return;
                
                const matriculaCompleta = getMatriculaComEmpresa(matricula);
                const nome = row.querySelector('[data-field="nome"]').value;
                const setorOrigem = row.querySelector('[data-field="setorOrigem"]').value;
                const cargoAtual = row.querySelector('[data-field="cargoAtual"]').value;
                const codSetorDestino = row.querySelector('[data-field="codSetorDestino"]').value;
                const setorDestino = row.querySelector('[data-field="setorDestino"]').value;
                const cargoProposto = row.querySelector('[data-field="cargoProposto"]').value;
                const cargoLideranca = row.querySelector('[data-field="cargoLideranca"]').value;
                const avaliacaoComp = row.querySelector('[data-field="avaliacaoComportamental"]').value;
                
                const dataAvalInput = row.querySelector('[data-field="dataAvaliacaoComp"]');
                let dataAval = getDateFieldValue(dataAvalInput);
                if (dataAval && dataAval !== 'N/A') dataAval = convertDateForDisplay(dataAval);
                
                const emTreinamento = row.querySelector('[data-field="emTreinamento"]').value;
                const possuiCarta = row.querySelector('[data-field="possuiCarta"]').value;
                
                const dataInicioInput = row.querySelector('[data-field="dataInicio"]');
                let dataInicio = getDateFieldValue(dataInicioInput);
                if (dataInicio && dataInicio !== 'N/A') dataInicio = convertDateForDisplay(dataInicio);
                
                const ehSubstituicao = row.querySelector('[data-field="ehSubstituicao"]').value;
                const matriculaSubst = row.querySelector('[data-field="matriculaSubstituto"]').value;
                const matriculaSubstCompleta = ehSubstituicao === 'SIM' && matriculaSubst ? getMatriculaComEmpresa(matriculaSubst) : matriculaSubst;
                const nomeSubst = row.querySelector('[data-field="nomeSubstituto"]').value;
                const motivoSubst = row.querySelector('[data-field="motivoSubstituicao"]').value;
                
                const dataDesligInput = row.querySelector('[data-field="dataDesligamento"]');
                let dataDeslig = getDateFieldValue(dataDesligInput);
                if (dataDeslig && dataDeslig !== 'N/A') dataDeslig = convertDateForDisplay(dataDeslig);

                const values = [
                    matriculaCompleta, nome, setorOrigem, cargoAtual, codSetorDestino,
                    setorDestino, cargoProposto, cargoLideranca, avaliacaoComp,
                    dataAval, emTreinamento, possuiCarta, dataInicio,
                    ehSubstituicao, matriculaSubstCompleta, nomeSubst, motivoSubst, dataDeslig
                ].map(v => `"${(v || '').replace(/"/g, '""')}"`);
                
                csv += values.join(';') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `Indicacoes_Promocao_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showInstructions() {
            document.getElementById('instructionsModal').classList.add('show');
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').classList.remove('show');
        }

        function showPDFModal() {
            // VERIFICA√á√ÉO DE MATR√çCULAS COM LETRAS (SEGURAN√áA EXTRA)
            const invalidMatriculas = checkNumericMatriculaBlock();
            if (invalidMatriculas.length > 0) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: O campo matr√≠cula deve conter APENAS n√∫meros.\n\nPEND√äNCIAS:\n' + invalidMatriculas.join('\n') + '\n\nPor favor, corrija as matr√≠culas antes de prosseguir.');
                return;
            }

            const duplicateCheck = hasDuplicatedMatriculas();
            if (duplicateCheck.hasDuplicates) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem matr√≠culas duplicadas na tabela.\n\nMatr√≠culas repetidas: ' + duplicateCheck.duplicatedValues.join(', ') + '\n\nPor favor, corrija as matr√≠culas duplicadas antes de gerar o PDF.');
                return;
            }

            const leadershipErrors = checkLeadershipBlock();
            if (leadershipErrors.length > 0) { 
                const listaNomes = leadershipErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem candidatos com Cargo de Lideran√ßa = SIM e Avalia√ß√£o Comportamental = N√ÉO.\n\n' +
                    'CANDIDATOS COM PEND√äNCIA:\n' + listaNomes + '\n\n' +
                    'Esses candidatos n√£o podem ser movimentados sem a "Avalia√ß√£o Comportamental" ter sido realizada por R & S.\n\n' +
                    'Por favor, retire-o(s) da lista a ser enviada para a √°rea de Remunera√ß√£o e Performance');
                return;
            }

            const trainingErrors = checkTrainingBlock();
            if (trainingErrors.length > 0) { 
                const listaNomes = trainingErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem candidatos que est√£o com Treinamento = SIM e Possui Carta = N√ÉO.\n\n' +
                    'CANDIDATOS COM PEND√äNCIA:\n' + listaNomes + '\n\n' +
                    'Esse(s) candidato(s) n√£o pode(m) ser movimentado(s) sem ter a Carta de Treinamento.\n\n' +
                    'Por favor, retire-o(s) da lista a ser enviada e contacte a Ger√™ncia do Departamento Pessoal para solicitar a elabora√ß√£o da carta de treinamento e coleta das assinaturas, considerando o tempo de forma√ß√£o de at√© 90 dias, antes da solicita√ß√£o de movimenta√ß√£o do empregado.');
                return;
            }

            const missingDateErrors = checkMissingDatesBlock();
            if (missingDateErrors.length > 0) {
                const listaNomes = missingDateErrors.join('\n');
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', '‚ùå BLOQUEADO: Existem informa√ß√µes de data obrigat√≥rias faltando.\n\n' +
                    'PEND√äNCIAS:\n' + listaNomes + '\n\n' +
                    'Por favor, preencha as datas destacadas em vermelho antes de gerar o PDF.');
                return;
            }

            const errors = validateRequiredFields();
            if (errors.length > 0) {
                showCustomAlert('‚ö†Ô∏è ATEN√á√ÉO', 'Preencha os campos obrigat√≥rios antes de gerar o PDF:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '));
                return;
            }

            let warningMessage = '';

            const responsavel = document.getElementById('responsavel').value;
            const empresaSelect = document.getElementById('empresa');
            const empresaText = empresaSelect.options[empresaSelect.selectedIndex].text;
            const rows = document.querySelectorAll('#tableBody tr');
            const selectedRows = document.querySelectorAll('.row-checkbox:checked').length;
            let totalRows = 0;
            rows.forEach(row => {
                const matricula = row.querySelector('[data-field="matricula"]').value;
                if (matricula) totalRows++;
            });

            const today = new Date().toLocaleDateString('pt-BR');
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                <p><strong>Respons√°vel:</strong> ${responsavel}</p>
                <p><strong>Empresa:</strong> ${empresaText}</p>
                <p><strong>Data de Gera√ß√£o:</strong> ${today}</p>
                <p><strong>Total de Linhas:</strong> ${totalRows}</p>
                ${selectedRows > 0 ? `<p><strong>Linhas Selecionadas:</strong> ${selectedRows} (apenas estas ser√£o exportadas)</p>` : ''}
                ${warningMessage}
                <p style="margin-top: 20px; color: var(--gray-medium);">O PDF ser√° gerado no formato A4 (paisagem) com margens de 0,1cm.</p>
                <div class="info-box" style="margin-top: 15px;">
                    <strong>üìß Lembre-se:</strong> Envie tanto o PDF quanto o Excel para a √°rea de Remunera√ß√£o e Performance.
                </div>
            `;

            document.getElementById('pdfModal').classList.add('show');
        }

        function closePDFModal() {
            document.getElementById('pdfModal').classList.remove('show');
        }

        async function generatePDF() {
            closePDFModal();
            const responsavel = document.getElementById('responsavel').value;
            const empresaSelect = document.getElementById('empresa');
            const empresaText = empresaSelect.options[empresaSelect.selectedIndex].text;
            const today = new Date().toLocaleDateString('pt-BR');
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            // T√≠tulo
            doc.setFontSize(16);
            doc.setTextColor(30, 58, 95); // #1e3a5f
            doc.text("Tabela de Indica√ß√µes para o Comit√™", 148.5, 15, { align: 'center' });

            // Linha info
            doc.setFontSize(9);
            doc.setTextColor(50, 50, 50);
            doc.text(`Data: ${today} | Respons√°vel: ${responsavel} | Empresa: ${empresaText}`, 148.5, 22, { align: 'center' });

            // Linha divis√≥ria
            doc.setDrawColor(30, 58, 95);
            doc.setLineWidth(0.6);
            doc.line(5, 25, 292, 25);

            // Preparar dados da tabela
            const headers = [[
                'Mat.', 'Nome', 'Setor Orig.', 'Cargo Atual', 'C√≥d. Set. Dest.', 
                'Setor Dest.', 'Cargo Prop.', 'Lider?', 'R&S?', 'Dt Aval.', 
                'Trein?', 'Carta?', 'Dt In√≠c.', 'Subst?', 'Mat. Sub.', 
                'Nome Sub.', 'Motivo', 'Dt Mot.'
            ]];

            const data = [];
            const rows = document.querySelectorAll('#tableBody tr');
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const hasSelection = selectedCheckboxes.length > 0;

            rows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                if (hasSelection && !checkbox.checked) return;

                const matricula = row.querySelector('[data-field="matricula"]').value;
                if (!matricula) return;

                const getVal = (selector) => {
                    const el = row.querySelector(selector);
                    // Para inputs date, verificar se est√° desabilitado (N/A)
                    if (el.type === 'date' && el.disabled) return '';
                    if (el.type === 'date' && el.value) return convertDateForDisplay(el.value);
                    return el.value || '';
                };

                const matriculaCompleta = getMatriculaComEmpresa(matricula);
                
                // Pegar valores usando os seletores corretos
                data.push([
                    matriculaCompleta,
                    getVal('[data-field="nome"]'),
                    getVal('[data-field="setorOrigem"]'),
                    getVal('[data-field="cargoAtual"]'),
                    getVal('[data-field="codSetorDestino"]'),
                    getVal('[data-field="setorDestino"]'),
                    getVal('[data-field="cargoProposto"]'),
                    getVal('[data-field="cargoLideranca"]'),
                    getVal('[data-field="avaliacaoComportamental"]'),
                    getVal('[data-field="dataAvaliacaoComp"]'), // Data Avalia√ß√£o
                    getVal('[data-field="emTreinamento"]'),
                    getVal('[data-field="possuiCarta"]'),
                    getVal('[data-field="dataInicio"]'), // Data In√≠cio
                    getVal('[data-field="ehSubstituicao"]'),
                    hasSelection && !checkbox.checked ? '' : (row.querySelector('[data-field="ehSubstituicao"]').value === 'SIM' ? getMatriculaComEmpresa(row.querySelector('[data-field="matriculaSubstituto"]').value) : ''), // Matr√≠cula Subst com prefixo se for substitui√ß√£o
                    getVal('[data-field="nomeSubstituto"]'),
                    getVal('[data-field="motivoSubstituicao"]'),
                    getVal('[data-field="dataDesligamento"]') // Data Motivo
                ]);
            });

            // Gerar Tabela
            doc.autoTable({
                head: headers,
                body: data,
                startY: 30,
                theme: 'grid',
                styles: { 
                    fontSize: 6, 
                    cellPadding: 1,
                    overflow: 'linebreak',
                    halign: 'left'
                },
                headStyles: {
                    fillColor: [30, 58, 95],
                    textColor: 255,
                    fontSize: 6,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 12 }, // Matr√≠cula
                    1: { cellWidth: 25 }, // Nome
                    7: { halign: 'center' }, // Lider
                    8: { halign: 'center' }, // R&S
                    10: { halign: 'center' }, // Trein
                    11: { halign: 'center' }, // Carta
                    13: { halign: 'center' }  // Subst
                },
                margin: { top: 30, left: 5, right: 5, bottom: 10 }
            });

            // Rodap√©
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Tabela criada e desenvolvida por Alan Silva', 148.5, 205, { align: 'center' });
            }

            doc.save(`Indicacoes_Promocao_${date}.pdf`);
        }

        window.onclick = function(event) {
            const pdfModal = document.getElementById('pdfModal');
            const instructionsModal = document.getElementById('instructionsModal');
            const customAlertModal = document.getElementById('customAlertModal');
            const customConfirmModal = document.getElementById('customConfirmModal');
            if (event.target === pdfModal) {
                closePDFModal();
            }
            if (event.target === instructionsModal) {
                closeInstructions();
            }
            if (event.target === customAlertModal) {
                closeCustomAlert();
            }
            if (event.target === customConfirmModal) {
                closeCustomConfirm();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                addRow();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                showPDFModal();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportCSV();
            }
            if (e.key === 'F1') {
                e.preventDefault();
                showInstructions();
            }
            if (e.key === 'Escape') {
                closePDFModal();
                closeInstructions();
                closeCustomAlert();
                closeCustomConfirm();
            }
        });
    </script>
</body>
</html>
